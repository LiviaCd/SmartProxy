global
    log stdout format raw local0
    maxconn 4096
    # daemon mode is not needed in Docker containers

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option forwardfor
    option http-server-close
    # Retry failed requests on another server
    retries 3
    # Retry requests on another server if connection fails
    option redispatch

# Statistics page
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-node
    stats auth admin:admin

# Frontend - listens on port 8080
frontend http_frontend
    bind *:8080
    default_backend api_backend

# Backend - load balancing between API instances
backend api_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    # Retry on connection errors
    option redispatch
    # Timeout for health checks (5s = faster failure detection)
    timeout check 5s
    # inter: interval between health checks (10s = faster detection)
    # fall: number of consecutive failures before marking as down (2 = faster failover)
    # rise: number of consecutive successes before marking as up (2 = faster recovery)
    # fastinter: interval during initial startup or when recovering (5s = faster recovery)
    server api1 api1:8080 check inter 10s fall 2 rise 2 fastinter 5s
    server api2 api2:8080 check inter 10s fall 2 rise 2 fastinter 5s
    server api3 api3:8080 check inter 10s fall 2 rise 2 fastinter 5s

